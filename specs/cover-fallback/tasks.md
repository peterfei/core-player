# 封面回退机制实施任务清单

## 阶段 1: 基础架构和配色方案

### 1.1 创建项目结构
- [ ] 创建 `lib/services/cover_fallback_service.dart`
- [ ] 创建 `lib/utils/default_cover_generator.dart`
- [ ] 创建 `lib/utils/video_thumbnail_extractor.dart`（专业版）
- [ ] 创建 `lib/models/cover_gradient.dart`
- [ ] 创建测试目录 `test/cover_fallback/`

### 1.2 定义渐变配色方案
- [ ] 在 `cover_gradient.dart` 中定义 `CoverGradient` 类
- [ ] 实现 8 种预设渐变配色方案
- [ ] 实现根据字符串哈希值选择配色的方法
- [ ] 添加单元测试验证同一名称返回相同配色

### 1.3 设置缓存目录
- [ ] 在应用初始化时创建 `metadata/covers/` 目录
- [ ] 在应用初始化时创建 `metadata/thumbnails/` 目录
- [ ] 添加目录权限检查和错误处理
- [ ] 测试在不同平台上的目录创建

## 阶段 2: 默认封面生成器

### 2.1 实现 Canvas 绘制
- [ ] 实现 `DefaultCoverGenerator.generateCover()` 方法
- [ ] 创建标准尺寸的 Canvas (300x450)
- [ ] 实现渐变背景绘制
- [ ] 添加错误处理（Canvas 创建失败）
- [ ] 测试渐变效果是否符合设计

### 2.2 实现文字渲染
- [ ] 实现剧集名称清理和格式化
- [ ] 在封面中央绘制剧集名称
- [ ] 实现多行文字自动换行
- [ ] 添加文字阴影增强可读性
- [ ] 在底部绘制集数统计
- [ ] 测试中文和英文文字渲染
- [ ] 测试超长名称的处理

### 2.3 实现封面导出和缓存
- [ ] 将 Canvas 导出为 JPEG 文件（quality: 85）
- [ ] 生成基于剧集 ID 的文件名
- [ ] 保存到 `metadata/covers/` 目录
- [ ] 实现缓存检查逻辑
- [ ] 添加文件系统错误处理
- [ ] 测试缓存命中和未命中情况

### 2.4 性能优化
- [ ] 确保单个封面生成时间 < 100ms
- [ ] 实现异步生成避免阻塞 UI
- [ ] 添加性能日志记录
- [ ] 进行性能测试和优化

## 阶段 3: 视频截图提取器（专业版）

### 3.1 依赖集成（可选）
- [ ] 评估是否使用 `video_thumbnail` 包或现有 ffmpeg
- [ ] 如使用新包，添加到 `pubspec.yaml`
- [ ] 运行 `flutter pub get`
- [ ] 测试依赖在各平台的可用性

### 3.2 实现截图提取
- [ ] 实现 `VideoThumbnailExtractor.extractThumbnail()` 方法
- [ ] 支持配置截图时间点（默认 10%）
- [ ] 实现视频解码和帧提取
- [ ] 保存截图到 `metadata/thumbnails/` 目录
- [ ] 添加解码错误处理
- [ ] 测试不同视频格式的提取

### 3.3 专业版功能检查
- [ ] 添加专业版功能标志检查
- [ ] 社区版跳过视频截图功能
- [ ] 在设置中显示/隐藏相关选项
- [ ] 测试专业版和社区版的行为差异

### 3.4 性能和缓存
- [ ] 确保后台线程执行，不阻塞 UI
- [ ] 实现截图缓存机制
- [ ] 添加性能日志
- [ ] 测试 1080p 和 4K 视频的提取性能

## 阶段 4: 封面回退服务

### 4.1 实现核心服务
- [ ] 实现 `CoverFallbackService.getCoverPath()` 方法
- [ ] 实现多层次回退逻辑：
  - [ ] 检查 TMDB posterPath
  - [ ] 尝试视频截图（专业版）
  - [ ] 生成默认封面
  - [ ] 最终回退到图标
- [ ] 添加详细的执行日志
- [ ] 实现异步处理

### 4.2 缓存优化
- [ ] 检查封面是否已缓存
- [ ] 缓存命中时快速返回（< 10ms）
- [ ] 实现缓存失效和更新机制
- [ ] 测试缓存性能

### 4.3 错误处理
- [ ] 处理 TMDB 封面下载失败
- [ ] 处理视频截图提取失败
- [ ] 处理默认封面生成失败
- [ ] 所有错误情况都有日志记录
- [ ] 测试各种错误场景

## 阶段 5: UI 集成

### 5.1 更新 SeriesFolderCard
- [ ] 导入 `CoverFallbackService`
- [ ] 修改封面路径获取逻辑
- [ ] 使用 `CoverFallbackService.getCoverPath(series)`
- [ ] 添加 loading 状态显示
- [ ] 测试封面显示效果

### 5.2 更新 VideoPosterCard
- [ ] 应用相同的封面回退逻辑
- [ ] 确保与 SeriesFolderCard 视觉一致
- [ ] 测试在不同场景下的显示

### 5.3 更新 SmartImage（可选）
- [ ] 考虑在 SmartImage 中集成回退逻辑
- [ ] 或保持当前实现，由调用方处理
- [ ] 统一错误占位符样式

## 阶段 6: 配置和设置

### 6.1 添加设置选项
- [ ] 在 `SettingsService` 中添加配置项：
  - [ ] `enableVideoThumbnails`: 是否启用视频截图
  - [ ] `defaultCoverStyle`: 默认封面样式（简约/丰富）
  - [ ] `thumbnailPosition`: 截图提取时间点
- [ ] 实现配置的保存和加载
- [ ] 测试配置持久化

### 6.2 更新设置界面
- [ ] 在 `settings_screen.dart` 中添加新设置项
- [ ] 添加 "封面设置" 分组
- [ ] 显示 "从视频提取封面" 开关（专业版）
- [ ] 显示 "默认封面样式" 选择器
- [ ] 社区版显示升级提示
- [ ] 测试设置界面交互

### 6.3 动态应用设置
- [ ] 设置变更后立即生效
- [ ] 通知 UI 刷新封面
- [ ] 测试设置变更的响应

## 阶段 7: 测试

### 7.1 单元测试
- [ ] 测试 `CoverGradient` 哈希值计算
- [ ] 测试 `DefaultCoverGenerator` 生成逻辑
- [ ] 测试 `VideoThumbnailExtractor` 提取逻辑
- [ ] 测试 `CoverFallbackService` 回退逻辑
- [ ] 覆盖率目标：> 80%

### 7.2 集成测试
- [ ] 测试完整的封面获取流程
- [ ] 测试多个剧集并发生成封面
- [ ] 测试缓存机制
- [ ] 测试错误处理和回退

### 7.3 UI 测试
- [ ] 测试 SeriesFolderCard 显示默认封面
- [ ] 测试封面 loading 状态
- [ ] 测试封面切换（TMDB → 默认）
- [ ] 测试在不同屏幕尺寸下的显示

### 7.4 性能测试
- [ ] 测量单个封面生成时间
- [ ] 测量 100 个封面批量生成时间
- [ ] 测量内存占用
- [ ] 测量存储空间占用
- [ ] 验证性能符合要求

### 7.5 平台兼容性测试
- [ ] 在 macOS 上测试完整功能
- [ ] 在 Windows 上测试完整功能
- [ ] 在 Linux 上测试完整功能
- [ ] 验证文件路径和权限在所有平台正常

## 阶段 8: 文档和优化

### 8.1 代码文档
- [ ] 为所有公共 API 添加文档注释
- [ ] 添加使用示例
- [ ] 更新相关 README

### 8.2 用户文档
- [ ] 在帮助文档中添加封面功能说明
- [ ] 说明默认封面的工作原理
- [ ] 说明视频截图功能（专业版）

### 8.3 性能优化
- [ ] 分析性能瓶颈
- [ ] 优化渲染性能
- [ ] 优化缓存策略
- [ ] 减少内存占用

### 8.4 用户体验优化
- [ ] 调整默认封面配色和样式
- [ ] 优化文字布局和大小
- [ ] 添加细节装饰元素
- [ ] 征集用户反馈并改进

## 阶段 9: 发布准备

### 9.1 最终测试
- [ ] 执行完整的验收测试计划
- [ ] 修复所有发现的 bug
- [ ] 确认所有成功标准都满足

### 9.2 发布说明
- [ ] 编写 CHANGELOG 条目
- [ ] 准备发布公告
- [ ] 准备演示截图/视频

### 9.3 部署
- [ ] 合并到主分支
- [ ] 标记版本号
- [ ] 发布更新

## 依赖关系

- 阶段 2 依赖阶段 1
- 阶段 3 可与阶段 2 并行
- 阶段 4 依赖阶段 2 和 3
- 阶段 5 依赖阶段 4
- 阶段 6 可与阶段 5 并行
- 阶段 7 依赖阶段 5 和 6
- 阶段 8 可在阶段 7 期间开始
- 阶段 9 依赖所有前置阶段

## 预计时间

- 阶段 1: 1 小时
- 阶段 2: 3 小时
- 阶段 3: 3 小时（可选，专业版）
- 阶段 4: 2 小时
- 阶段 5: 1 小时
- 阶段 6: 1 小时
- 阶段 7: 2 小时
- 阶段 8: 1 小时
- 阶段 9: 30 分钟

**总计**: 约 14.5 小时（包含专业版功能）
**基础版本**（不含视频截图）: 约 11.5 小时
