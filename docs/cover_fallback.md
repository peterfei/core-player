# 封面回退机制文档

## 概述

封面回退机制确保在无法获取在线元数据（如 TMDB 封面）时，用户界面仍能展示美观且有意义的封面图像。该机制通过多级回退策略，依次尝试获取最佳可用图像。

## 回退策略

系统按照以下优先级顺序尝试获取封面：

1.  **TMDB 在线封面**：如果存在有效的 TMDB 海报路径（网络 URL 或本地缓存文件），优先使用。
2.  **视频截图（专业版）**：如果启用了“视频截图”功能（仅限专业版），且存在本地视频文件，系统将尝试从视频中提取截图作为封面。
3.  **默认生成封面**：如果以上均不可用，系统将根据视频标题和哈希值生成一个带有渐变背景和文字标题的默认封面。

## 功能特性

### 1. 默认封面生成器
- **渐变背景**：根据视频标题的哈希值，从预设的 8 种渐变配色方案中选择一种，确保同一视频始终生成相同的背景。
- **文字渲染**：自动提取视频标题，并在封面上居中绘制。支持多行显示和文字阴影，确保清晰可读。
- **装饰纹理**：在背景上添加微妙的圆形纹理，增加视觉层次感。
- **本地缓存**：生成的封面会缓存到 `metadata/covers/` 目录，避免重复生成。

### 2. 视频截图提取器（专业版）
- **自动提取**：使用 FFmpeg 从视频文件的第 10 秒处提取高清晰度截图。
- **性能优化**：提取操作在后台异步进行，不会阻塞 UI 线程。
- **本地缓存**：提取的截图缓存到 `metadata/thumbnails/` 目录。
- **配置开关**：用户可以在设置中开启或关闭此功能。

## 配置指南

用户可以通过“设置 -> 元数据与封面设置”进行配置：

- **使用视频截图作为封面**：开关。开启后，当无在线封面时尝试提取视频截图。
- **默认封面样式**：下拉选择。目前支持“渐变”样式。

## 开发指南

### 核心类

- `CoverFallbackService`: 核心服务类，负责协调封面获取逻辑。
  - `getCoverPath(series)`: 获取最佳封面路径。
- `DefaultCoverGenerator`: 工具类，负责生成默认渐变封面。
- `VideoThumbnailExtractor`: 工具类，负责提取视频截图。
- `CoverGradient`: 模型类，定义渐变配色方案。

### 目录结构

- `lib/services/cover_fallback_service.dart`
- `lib/utils/default_cover_generator.dart`
- `lib/utils/video_thumbnail_extractor.dart`
- `lib/models/cover_gradient.dart`

## 依赖

- `path_provider`: 获取应用目录。
- `ffmpeg` (系统命令): 用于视频截图提取 (Mac/Linux)。
